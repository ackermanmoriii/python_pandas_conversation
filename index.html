<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Ø³ÙˆÙ¾Ø± Ø§Ù¾: Ø§ÛŒØ¯Ù‡ØŒ Ú©Ø¯ØŒ Ùˆ ØªØ¬Ø³Ù…</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/theme-monokai.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/mode-python.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/mode-text.js"></script>

    <style>
        /* ÙÙˆÙ†Øª ÙˆØ²ÛŒØ±Ù…ØªÙ† */
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body {
            font-family: 'Vazirmatn', sans-serif;
        }

        /* --- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØ¨ Û± (Ø§ÛŒØ¯Ù‡ Ø¨Ù‡ Ú©Ø¯) --- */
        .ace-output-container {
            height: 400px; /* Ø§Ø±ØªÙØ§Ø¹ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ Ú©Ø¯ */
            width: 100%;
            border-radius: 0.5rem;
            border: 1px solid #4B5563; /* gray-600 */
        }
        
        /* Monokai-styled <pre> block (Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ Ù…Ø¯Ù„ Ø¨ØµØ±ÛŒ ØªØ¨ 2 - Ø¯ÛŒÚ¯Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ù…ÛŒ Ø´ÙˆØ¯) */
        .monokai-pre {
            background-color: #272822;
            color: #F8F8F2;
            padding: 1em;
            border-radius: 0.5rem;
            font-family: "Consolas", "Courier New", monospace;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre-wrap;
            min-height: 400px;
            direction: ltr;
            text-align: left;
        }

        /* --- (Ø¬Ø¯ÛŒØ¯) Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØ¨ Û² (ØªØ¬Ø³Ù… Ù‡ÛŒØ¨Ø±ÛŒØ¯ÛŒ) --- */
        /* Ø§ÛŒÙ† Ø§Ø³ØªØ§ÛŒÙ„ Ù‡Ø§ Ø§Ø² replace_pandas.html Ø¢Ù…Ø¯Ù‡ Ø§Ù†Ø¯ */
        #hybrid-editor {
            width: 100%;
            height: 40vh; /* Ø§Ø±ØªÙØ§Ø¹ Ø§Ø¯ÛŒØªÙˆØ± ÙˆØ±ÙˆØ¯ÛŒ ØªØ¨ Û² */
            border-radius: 0.5rem;
            border: 1px solid #4B5563;
        }
        #hybrid-output-container {
            background-color: #272822;
            color: #F8F8F2;
            padding: 1.5em;
            border-radius: 0.5rem;
            font-family: 'Vazirmatn', 'Inter', sans-serif;
            line-height: 1.7;
            width: 100%;
            height: 70vh; /* Ø§Ø±ØªÙØ§Ø¹ Ø®Ø±ÙˆØ¬ÛŒ ØªØ¨ Û² */
            overflow-y: auto;
            border: 1px solid #4B5563;
        }
        #hybrid-output-container h3 {
            font-size: 1.25rem;
            font-weight: bold;
            color: #66D9EF;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-family: 'Vazirmatn', 'Inter', sans-serif;
            border-bottom: 1px solid #4B5563;
            padding-bottom: 5px;
        }
        #hybrid-output-container h3 code {
            font-family: "Consolas", "Courier New", monospace;
            color: #E6DB74;
            direction: ltr;
            display: block;
        }
        #hybrid-output-container p {
            margin-bottom: 1rem;
        }
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ú©Ø¯ Ø¯Ø±ÙˆÙ† Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù Ù‡Ø§ */
        #hybrid-output-container p code, #hybrid-output-container li code {
            font-family: "Consolas", "Courier New", monospace;
            color: #E6DB74;
            background-color: #3E3D32;
            padding: 2px 5px;
            border-radius: 4px;
            direction: ltr;
        }
        .pandas-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            direction: ltr;
            font-family: "Consolas", "Courier New", monospace;
        }
        .pandas-table th, .pandas-table td {
            border: 1px solid #4B5563;
            padding: 8px 12px;
            text-align: left;
        }
        .pandas-table th {
            background-color: #3E3D32;
            color: #E6DB74;
        }
        .pandas-table td {
            background-color: #272822;
            color: #F8F8F2;
        }
        .pandas-table .highlight-new {
            background-color: #A6E22E;
            color: #272822;
            font-weight: bold;
        }
        #hybrid-output-container hr {
            border-color: #4B5563;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        .placeholder-text {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #75715E;
        }
        /* --- (Ù¾Ø§ÛŒØ§Ù† Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØ¨ Û²) --- */


        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ¨ */
        .tab-btn {
            @apply px-6 py-3 font-bold text-gray-400 rounded-t-lg transition-colors;
        }
        .tab-btn.active {
            @apply text-blue-400 bg-gray-800 border-b-2 border-blue-400;
        }
        .tab-btn:not(.active):hover {
            @apply text-gray-200;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-6">

        <h1 class="text-3xl font-bold text-center text-white mb-6">
            ğŸ’¡ Ø³ÙˆÙ¾Ø± Ø§Ù¾: Ø§ÛŒØ¯Ù‡ØŒ Ú©Ø¯ØŒ Ùˆ ØªØ¬Ø³Ù… Ù‡ÛŒØ¨Ø±ÛŒØ¯ÛŒ
        </h1>

        <div class="max-w-md mx-auto mb-8 p-6 bg-gray-800 rounded-lg shadow-lg">
            <label for="api-key" class="block text-sm font-bold text-gray-300 mb-2">
                ğŸ”‘ Ú©Ù„ÛŒØ¯ API Ú¯ÙˆÚ¯Ù„ (Gemini)
            </label>
            <input type="password" id="api-key"
                   class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="Ú©Ù„ÛŒØ¯ API Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...">
            <button id="save-key-btn" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">
                Ø°Ø®ÛŒØ±Ù‡ Ú©Ù„ÛŒØ¯
            </button>
            <p id="api-status" class="text-xs text-green-500 mt-2 text-center hidden">
                âœ… Ú©Ù„ÛŒØ¯ API Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.
            </p>
        </div>

        <div class="border-b border-gray-700 mb-6">
            <nav class="flex -mb-px justify-center">
                <button id="tab1-btn" class="tab-btn active">Ø§ÛŒØ¯Ù‡ Ø¨Ù‡ Ú©Ø¯ (Text-to-Code)</button>
                <button id="tab2-btn" class="tab-btn">ØªÙˆØ¶ÛŒØ­ Ùˆ ØªØ¬Ø³Ù… Ù‡ÛŒØ¨Ø±ÛŒØ¯ÛŒ</button>
            </nav>
        </div>

        <div id="tab1-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h2 class="text-xl font-bold mb-3">Ø§ÛŒØ¯Ù‡ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ Ú©Ø¯ Ù¾Ø§ÛŒØªÙˆÙ† ØªØ¨Ø¯ÛŒÙ„ Ú©Ù†ÛŒØ¯</h2>
                    <label for="prompt-code-input" class="block text-sm font-medium text-gray-400 mb-2">
                        Ø§ÛŒØ¯Ù‡ ÛŒØ§ Ø¯Ø³ØªÙˆØ± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ ÛŒØ§ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯:
                    </label>
                    <textarea id="prompt-code-input" rows="5"
                              class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Ù…Ø«Ø§Ù„: Ø±Ø¯ÛŒÙ Ø´Ù…Ø§Ø±Ù‡ Ø³Ù‡ Ø§Ø² DataFrame x Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡"></textarea>
                    <button id="generate-code-btn"
                            class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition disabled:opacity-50">
                        ğŸš€ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ú©Ø¯
                    </button>
                </div>
                <div>
                    <h2 class="text-xl font-bold mb-3">Ú©Ø¯ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡:</h2>
                    <div id="code-output-editor" class="ace-output-container"></div>
                </div>
            </div>
        </div>

        <div id="tab2-content" class="hidden">
            <div class="flex flex-col gap-6">
                
                <div class="bg-gray-800 p-6 shadow-lg rounded-lg">
                    <h2 class="text-2xl font-bold mb-4 text-white">Û±. Ù…Ù†Ø§Ø¨Ø¹ Ø¯Ø§Ù†Ø´ (URL)</h2>
                    <p class="text-sm text-gray-400 mb-4">
                        URL Ù…Ø³ØªÙ†Ø¯Ø§Øª ÛŒØ§ Ù…Ù‚Ø§Ù„Ø§ØªÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Gemini Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¢Ù†â€ŒÙ‡Ø§ Ù¾Ø§Ø³Ø® Ø¯Ù‡Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.
                    </p>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="hybrid-data-url-input"
                               class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="https://pandas.pydata.org/docs/...">
                        <button id="hybrid-add-url-button"
                                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
                            Ø§ÙØ²ÙˆØ¯Ù†
                        </button>
                    </div>
                    <div id="hybrid-url-list-container" class="flex flex-col gap-2">
                        </div>
                </div>

                <div class="bg-gray-800 p-6 shadow-lg rounded-lg">
                    <h2 class="text-2xl font-bold mb-4 text-white">Û². Ú©Ø¯ Ù¾Ø§ÛŒØªÙˆÙ†</h2>
                    <p class="text-sm text-gray-400 mb-4">
                        Ú©Ø¯ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ù†Ø§Ø¨Ø¹ Ø¨Ø§Ù„Ø§ ØªÙˆØ¶ÛŒØ­ Ø¯Ø§Ø¯Ù‡ Ùˆ ØªØ¬Ø³Ù… Ø´ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.
                    </p>
                    <div id="hybrid-editor"></div> <button id="hybrid-analyze-button"
                            class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                        ØªÙˆØ¶ÛŒØ­ Ùˆ ØªØ¬Ø³Ù…! ğŸš€
                    </button>
                </div>

                <div class="bg-gray-800 p-6 shadow-lg rounded-lg">
                    <h2 class="text-2xl font-bold mb-4 text-white">Û³. ØªØ­Ù„ÛŒÙ„ Ùˆ ØªØ¬Ø³Ù… (Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± Ù…Ù†Ø¨Ø¹)</h2>
                    <div id="hybrid-output-container"> <div class="placeholder-text">
                            <p class="text-gray-500">
                                Ù¾Ø§Ø³Ø® Gemini Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                            </p>
                        </div>
                    </div>
                </div>

            </div>
            </div>
    </div>

    <script>
        // --- Ù¾Ø±Ø§Ù…Ù¾Øª Ø³ÛŒØ³ØªÙ… ØªØ¨ Û± (Ø§ÛŒØ¯Ù‡ Ø¨Ù‡ Ú©Ø¯) ---
        // (Ø§ÛŒÙ† Ù¾Ø±Ø§Ù…Ù¾Øª Ø§Ø² index.html Ø§ØµÙ„ÛŒ Ø´Ù…Ø§ Ø¢Ù…Ø¯Ù‡ Ø§Ø³Øª)
        const SYSTEM_PROMPT_CODER = `
You are an expert Python and Pandas code generation assistant.
The user will provide a natural language prompt (in Persian or English).
You must return *only* the raw Python code that best achieves their goal.

RULES:
1.  **DO NOT** add any explanations, greetings, apologies, or conversational text.
2.  **DO NOT** use markdown formatting like \`\`\`python ... \`\`\`.
3.  Return *only* the raw code block.
4.  If the user asks for "row number 3" (Ø±Ø¯ÛŒÙ Ø´Ù…Ø§Ø±Ù‡ Ø³Ù‡) of dataframe \`x\`, assume they mean the third row by *position* (0-based indexing), so you should return \`x.iloc[2]\`.
5.  If the user asks for "the row with index label 3" (Ø±Ø¯ÛŒÙ Ø¨Ø§ Ø¨Ø±Ú†Ø³Ø¨ Û³), return \`x.loc[3]\`.
`;
        
        // --- (Ø¬Ø¯ÛŒØ¯) Ù¾Ø±Ø§Ù…Ù¾Øª Ø³ÛŒØ³ØªÙ… ØªØ¨ Û² (Ù‡ÛŒØ¨Ø±ÛŒØ¯ÛŒ) ---
        // (Ø§ÛŒÙ† Ù¾Ø±Ø§Ù…Ù¾Øª Ø§Ø² replace_pandas.html Ø¢Ù…Ø¯Ù‡ Ø§Ø³Øª)
        function get_gemini_prompt_hybrid(user_code, url_list) {
            const url_context_block = url_list.length > 0 ? `
---
**KNOWLEDGE SOURCES (Ù…Ù†Ø§Ø¨Ø¹ Ø¯Ø§Ù†Ø´):**
Your knowledge is STRICTLY LIMITED to the content found at the following URLs.
Your FIRST TASK is to fetch and thoroughly read the content from these URLs.
You MUST NOT use any general knowledge unless the answer is not in these sources.

**PROVIDED URLs:**
${url_list.map(url => `- ${url}`).join('\n')}
---
` : `
---
**NO KNOWLEDGE SOURCES PROVIDED.**
You must answer using your general knowledge.
---
`;

            return `
You are a "Hybrid AI Code Explainer and Pandas Visualizer".
Your knowledge is grounded in the documents provided by the user.

${url_context_block}

**USER'S CODE TO ANALYZE:**
\`\`\`python
${user_code}
\`\`\`
---
**YOUR TASK (ÙˆØ¸ÛŒÙÙ‡ Ø´Ù…Ø§):**
Your task is to provide a step-by-step analysis of the user's code.
1.  Analyze the user's code line by line.
2.  Identify *only* the key lines, especially those that create or modify a Pandas DataFrame (e.g., \`pd.DataFrame\`, \`df['new_col'] = ...\`, \`df.groupby()\`, \`df.merge()\`).
3.  For each identified line, you MUST generate an HTML block containing **TWO PARTS**:
    
    **Part A: The Explanation (ØªÙˆØ¶ÛŒØ­)**
    * An \`<h3>\` tag containing the exact line of code wrapped in \`<code>\`.
    * A \`<p>\` tag explaining *what* the operation does.
    * **CRITICAL RULE:** This explanation MUST be based on the information found in the PROVIDED URLs (if any). Be friendly and simple.
    
    **Part B: The Visualization (ØªØ¬Ø³Ù…)**
    * If the line *results in a DataFrame*, you MUST ALSO provide:
    * A \`<p><strong>DataFrame State (showing 'df_name.head(5)'):</strong></p>\` tag. (Use the correct variable name).
    * An HTML \`<table>\` representing the \`.head(5)\` of the *resulting* DataFrame.
    * Use this exact structure: \`<table class="pandas-table">\`.
    * Use \`<thead>\`, \`<tbody>\`, \`<th>\`, \`<td>\`.
    * If a column is *new* or *modified* in that step, add the class \`"highlight-new"\` to its \`<th>\` and ALL its \`<td>\` cells.

4.  **OUTPUT FORMAT:**
    * You MUST ONLY output the raw HTML blocks.
    * Separate each step's block with an \`<hr>\` tag.
    * DO NOT wrap the output in \`\`\`html ... \`\`\`.
    * DO NOT include \`<html>\`, \`<head>\`, or \`<body>\` tags.

---
**EXAMPLE OF YOUR TASK:**
\`\`\`
<h3><code>df = pd.DataFrame({'age': [25, 30]})</code></h3>
<p>Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù¾Ø§Ù†Ø¯Ø§Ø³ØŒ Ø§ÛŒÙ† Ø®Ø· ÛŒÚ© Ø¯ÛŒØªØ§ÙØ±ÛŒÙ… Ø¬Ø¯ÛŒØ¯ Ø§Ø² ÛŒÚ© Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯...</p>
<p><strong>DataFrame State (showing 'df.head(5)'):</strong></p>
<table class="pandas-table">
  <thead><tr><th class="highlight-new">age</th></tr></thead>
  <tbody>
    <tr><td class="highlight-new">25</td></tr>
    <tr><td class="highlight-new">30</td></tr>
  </tbody>
</table>
<hr>
<h3><code>df['is_adult'] = df['age'] > 28</code></h3>
<p>Ø§ÛŒÙ†Ø¬Ø§ Ù…Ø§ Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ø³ØªÙˆÙ† Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù†Ø§Ù… 'is_adult' Ù‡Ø³ØªÛŒÙ…...</p>
<p><strong>DataFrame State (showing 'df.head(5)'):</strong></p>
<table class="pandas-table">
  <thead>
    <tr><th>age</th><th class="highlight-new">is_adult</th></tr>
  </thead>
  <tbody>
    <tr><td>25</td><td class="highlight-new">False</td></tr>
    <tr><td>30</td><td class="highlight-new">True</td></tr>
  </tbody>
</table>
\`\`\`
---
Now, apply this hybrid logic to the user's code.
`;
        }
        
        // (Ø¬Ø¯ÛŒØ¯) Ú©Ø¯ Ù¾ÛŒØ´ ÙØ±Ø¶ Ø¨Ø±Ø§ÛŒ Ø§Ø¯ÛŒØªÙˆØ± ØªØ¨ Û²
        const DEFAULT_HYBRID_CODE = `import pandas as pd
data = {
    'product_name': ['A', 'B', 'A', 'B', 'A'],
    'quantity': [10, 5, 8, 12, 5],
    'price': [100, 150, 100, 150, 100]
}
df = pd.DataFrame(data)
df['total_value'] = df['quantity'] * df['price']
df_summary = df.groupby('product_name')['total_value'].sum().reset_index()
print(df_summary)
`;

        // --- Global State ---
        let apiKey = null;
        let codeOutputEditor; // Ø§Ø¯ÛŒØªÙˆØ± ØªØ¨ Û±
        let hybridEditor; // Ø§Ø¯ÛŒØªÙˆØ± ØªØ¨ Û²

        // --- DOM Elements ---
        // Ù…Ø´ØªØ±Ú©
        const tab1Btn = document.getElementById('tab1-btn');
        const tab2Btn = document.getElementById('tab2-btn');
        const tab1Content = document.getElementById('tab1-content');
        const tab2Content = document.getElementById('tab2-content');
        const apiKeyInput = document.getElementById('api-key');
        const saveKeyBtn = document.getElementById('save-key-btn');
        const apiStatus = document.getElementById('api-status');

        // ØªØ¨ Û±
        const promptCodeInput = document.getElementById('prompt-code-input');
        const generateCodeBtn = document.getElementById('generate-code-btn');
        
        // (Ø¬Ø¯ÛŒØ¯) ØªØ¨ Û²
        const hybridAnalyzeButton = document.getElementById('hybrid-analyze-button');
        const hybridOutputContainer = document.getElementById('hybrid-output-container');
        const hybridDataUrlInput = document.getElementById('hybrid-data-url-input');
        const hybridAddUrlButton = document.getElementById('hybrid-add-url-button');
        const hybridUrlListContainer = document.getElementById('hybrid-url-list-container');


        // --- Main App Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. Initialize Ace Editors
            
            // Ø§Ø¯ÛŒØªÙˆØ± ØªØ¨ Û± (Ø§ÛŒØ¯Ù‡ Ø¨Ù‡ Ú©Ø¯) - ÙÙ‚Ø· Ø®ÙˆØ§Ù†Ø¯Ù†ÛŒ
            codeOutputEditor = ace.edit("code-output-editor");
            codeOutputEditor.setTheme("ace/theme/monokai");
            codeOutputEditor.session.setMode("ace/mode/python");
            codeOutputEditor.setReadOnly(true);
            codeOutputEditor.setValue("# Ú©Ø¯ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯", -1);

            // (Ø¬Ø¯ÛŒØ¯) Ø§Ø¯ÛŒØªÙˆØ± ØªØ¨ Û² (ØªØ¬Ø³Ù… Ù‡ÛŒØ¨Ø±ÛŒØ¯ÛŒ) - Ù‚Ø§Ø¨Ù„ Ù†ÙˆØ´ØªÙ†
            hybridEditor = ace.edit("hybrid-editor"); // Ø¨Ø§ ID Ø¬Ø¯ÛŒØ¯
            hybridEditor.setTheme("ace/theme/monokai");
            hybridEditor.session.setMode("ace/mode/python");
            hybridEditor.setValue(DEFAULT_HYBRID_CODE, -1);
            hybridEditor.setFontSize(14);
            hybridEditor.container.style.direction = "ltr";
            
            // 2. Setup Event Listeners

            // (Ø¨Ù‡ Ø±ÙˆØ² Ø´Ø¯Ù‡) Ù…Ù†Ø·Ù‚ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù„ÛŒØ¯ API Ø¨Ø§ localStorage
            apiKeyInput.value = localStorage.getItem('gemini_api_key') || '';
            if (apiKeyInput.value) {
                apiKey = apiKeyInput.value;
                apiStatus.classList.remove('hidden');
                apiStatus.textContent = 'âœ… Ú©Ù„ÛŒØ¯ API Ø§Ø² Ø­Ø§ÙØ¸Ù‡ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯.';
            }
            saveKeyBtn.addEventListener('click', () => {
                if (apiKeyInput.value) {
                    apiKey = apiKeyInput.value;
                    localStorage.setItem('gemini_api_key', apiKey); // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
                    apiStatus.classList.remove('hidden');
                    apiStatus.textContent = 'âœ… Ú©Ù„ÛŒØ¯ API Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.';
                }
            });

            // ØªØ¹ÙˆÛŒØ¶ ØªØ¨
            tab1Btn.addEventListener('click', () => {
                tab1Content.classList.remove('hidden');
                tab2Content.classList.add('hidden');
                tab1Btn.classList.add('active');
                tab2Btn.classList.remove('active');
            });

            tab2Btn.addEventListener('click', () => {
                tab1Content.classList.add('hidden');
                tab2Content.classList.remove('hidden');
                tab1Btn.classList.remove('active');
                tab2Btn.classList.add('active');
            });

            // Ø´Ù†ÙˆÙ†Ø¯Ù‡ Ø¯Ú©Ù…Ù‡ ØªØ¨ Û±
            generateCodeBtn.addEventListener('click', handleGenerateCode);

            // (Ø¬Ø¯ÛŒØ¯) Ø´Ù†ÙˆÙ†Ø¯Ù‡ Ù‡Ø§ÛŒ Ø¯Ú©Ù…Ù‡ ØªØ¨ Û²
            hybridAnalyzeButton.addEventListener('click', handleGenerateHybrid);
            hybridAddUrlButton.addEventListener('click', () => {
                const newUrl = hybridDataUrlInput.value.trim();
                if (newUrl) {
                    let currentUrls = JSON.parse(localStorage.getItem('pandas_urls_hybrid') || '[]');
                    currentUrls.push(newUrl);
                    localStorage.setItem('pandas_urls_hybrid', JSON.stringify(currentUrls));
                    hybridDataUrlInput.value = '';
                    renderHybridUrlList(); // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ ØªØ§Ø¨Ø¹ Ø±Ù†Ø¯Ø± ØªØ¨ Û²
                }
            });

            // (Ø¬Ø¯ÛŒØ¯) Ø±Ù†Ø¯Ø± Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª URL Ù‡Ø§ÛŒ ØªØ¨ Û² Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡
            renderHybridUrlList();
        });

        // --- (Ù…Ø§Ù†Ø¯Ú¯Ø§Ø±) ØªÙˆØ§Ø¨Ø¹ ØªØ¨ Û± ---

        async function handleGenerateCode() {
            if (!validateApiKey()) return;
            
            const prompt = promptCodeInput.value;
            if (!prompt.trim()) {
                alert("Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ Ø§ÛŒØ¯Ù‡ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯.");
                return;
            }

            setLoading(generateCodeBtn, '... Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´');
            codeOutputEditor.setValue("... ğŸ§  Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø§ Gemini", -1);
            codeOutputEditor.session.setMode("ace/mode/text");

            try {
                // ØªÙ…Ø§Ø³ Ø¨Ø§ ØªØ§Ø¨Ø¹ API Ù…Ø®ØµÙˆØµ ØªØ¨ Û±
                const generatedCode = await callGemini_Tab1(prompt, SYSTEM_PROMPT_CODER);
                codeOutputEditor.setValue(generatedCode, -1);
                codeOutputEditor.session.setMode("ace/mode/python");
            } catch (error) {
                codeOutputEditor.setValue(`Ø®Ø·Ø§: ${error.message}`, -1);
            } finally {
                setLoading(generateCodeBtn, 'ğŸš€ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ú©Ø¯', false);
            }
        }

        // ØªØ§Ø¨Ø¹ ØªÙ…Ø§Ø³ API ØªØ¨ Û± (Ø§ÛŒØ¯Ù‡ Ø¨Ù‡ Ú©Ø¯)
        async function callGemini_Tab1(prompt, systemInstruction) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: { "temperature": 0.0, "maxOutputTokens": 2048 },
                safetySettings: [
                    { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
                    { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
                    { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
                    { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
                ]
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            return handleApiResponse(response); // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù‡Ù†Ø¯Ù„Ø± Ù…Ø´ØªØ±Ú©
        }


        // --- (Ø¬Ø¯ÛŒØ¯) ØªÙˆØ§Ø¨Ø¹ ØªØ¨ Û² (ØªØ¬Ø³Ù… Ù‡ÛŒØ¨Ø±ÛŒØ¯ÛŒ) ---
        // (ØªÙ…Ø§Ù… Ø§ÛŒÙ† ØªÙˆØ§Ø¨Ø¹ Ø§Ø² replace_pandas.html Ø¢Ù…Ø¯Ù‡ Ø§Ù†Ø¯)

        async function handleGenerateHybrid() {
            if (!validateApiKey()) return;

            const userCode = hybridEditor.getValue(); // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ø¯ÛŒØªÙˆØ± ØªØ¨ Û²
            if (!userCode.trim()) {
                alert("Ù„Ø·ÙØ§ Ù…Ù‚Ø¯Ø§Ø±ÛŒ Ú©Ø¯ Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
                return;
            }
            
            const urlList = JSON.parse(localStorage.getItem('pandas_urls_hybrid') || '[]');

            setLoading(hybridAnalyzeButton, 'Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„...');
            hybridOutputContainer.innerHTML = `
                <div class="placeholder-text">
                    <p class="text-blue-400">Gemini Ø¯Ø± Ø­Ø§Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† Ù…Ù†Ø§Ø¨Ø¹ØŒ ØªÙˆØ¶ÛŒØ­ Ùˆ ØªØ¬Ø³Ù… Ø§Ø³Øª... ğŸ§ </p>
                </div>`;

            try {
                const prompt = get_gemini_prompt_hybrid(userCode, urlList);
                // ØªÙ…Ø§Ø³ Ø¨Ø§ ØªØ§Ø¨Ø¹ API Ù…Ø®ØµÙˆØµ ØªØ¨ Û²
                const visual_html = await callGemini_Tab2(prompt);
                displayHybridOutput(visual_html);
            } catch (error) {
                hybridOutputContainer.innerHTML = `
                    <div class="placeholder-text" style="align-items: flex-start;">
                        <p class="text-red-400 p-4" style="direction: ltr; text-align: left;">
                            <strong>Error:</strong> ${escapeHTML(error.message)}
                        </p>
                    </div>`;
                console.error("API Error:", error);
            } finally {
                setLoading(hybridAnalyzeButton, 'ØªÙˆØ¶ÛŒØ­ Ùˆ ØªØ¬Ø³Ù…! ğŸš€', false);
            }
        }

        // ØªØ§Ø¨Ø¹ ØªÙ…Ø§Ø³ API ØªØ¨ Û² (Ù‡ÛŒØ¨Ø±ÛŒØ¯ÛŒ)
        async function callGemini_Tab2(promptText) {
            // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…Ø¯Ù„ Pro Ø¨Ø±Ø§ÛŒ Ù‚Ø§Ø¨Ù„ÛŒØª Ø®ÙˆØ§Ù†Ø¯Ù† URL Ùˆ Ø²Ù…ÛŒÙ†Ù‡ Ø¨Ø²Ø±Ú¯ØªØ±
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{
                    parts: [{ text: promptText }] // Ù¾Ø±Ø§Ù…Ù¾Øª Ú©Ø§Ù…Ù„ (Ø´Ø§Ù…Ù„ Ø¯Ø³ØªÙˆØ± Ø³ÛŒØ³ØªÙ…) Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒ Ø¢ÛŒØ¯
                }],
                generationConfig: { "temperature": 0.0, "maxOutputTokens": 4096 },
                safetySettings: [
                    { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
                    { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
                    { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
                    { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
                ]
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            return handleApiResponse(response); // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù‡Ù†Ø¯Ù„Ø± Ù…Ø´ØªØ±Ú©
        }

        // ØªØ§Ø¨Ø¹ Ø±Ù†Ø¯Ø± Ø®Ø±ÙˆØ¬ÛŒ ØªØ¨ Û²
        function displayHybridOutput(html_content) {
            const clean_html = html_content.replace(/```html/g, "").replace(/```/g, "").trim();
            hybridOutputContainer.innerHTML = clean_html;
            
            if (clean_html.length === 0) {
                 hybridOutputContainer.innerHTML = `
                    <div class="placeholder-text">
                        <p class="text-yellow-400">
                            Gemini Ù¾Ø§Ø³Ø®ÛŒ ØªÙˆÙ„ÛŒØ¯ Ù†Ú©Ø±Ø¯ ÛŒØ§ Ø¹Ù…Ù„ÛŒØ§ØªÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¬Ø³Ù… Ù¾ÛŒØ¯Ø§ Ù†Ú©Ø±Ø¯.
                        </p>
                    </div>`;
            }
        }
        
        // ØªØ§Ø¨Ø¹ Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª URL Ø¨Ø±Ø§ÛŒ ØªØ¨ Û²
        function renderHybridUrlList() {
            hybridUrlListContainer.innerHTML = '';
            // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÛŒÚ© Ú©Ù„ÛŒØ¯ localStorage Ù…ØªÙØ§ÙˆØª Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØ¯Ø§Ø®Ù„
            const urls = JSON.parse(localStorage.getItem('pandas_urls_hybrid') || '[]');
            
            urls.forEach((url, index) => {
                const urlElement = document.createElement('div');
                urlElement.className = 'flex items-center justify-between bg-gray-700 p-2 rounded-lg';
                urlElement.innerHTML = `
                    <span class="text-sm text-gray-300 truncate" style="direction: ltr; text-align: left;">${escapeHTML(url)}</span>
                    <button class="remove-url-button bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded-md" data-index="${index}">
                        Ø­Ø°Ù
                    </button>
                `;
                hybridUrlListContainer.appendChild(urlElement);
            });

            hybridUrlListContainer.querySelectorAll('.remove-url-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const indexToRemove = parseInt(e.target.dataset.index, 10);
                    let currentUrls = JSON.parse(localStorage.getItem('pandas_urls_hybrid') || '[]');
                    currentUrls.splice(indexToRemove, 1);
                    localStorage.setItem('pandas_urls_hybrid', JSON.stringify(currentUrls));
                    renderHybridUrlList();
                });
            });
        }


        // --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ù…Ø´ØªØ±Ú© ---

        // (Ø¬Ø¯ÛŒØ¯) Ù‡Ù†Ø¯Ù„Ø± Ù…Ø´ØªØ±Ú© Ù¾Ø§Ø³Ø® API
        async function handleApiResponse(response) {
            if (!response.ok) {
                const errorData = await response.json();
                let message = errorData.error.message || `HTTP error! status: ${response.status}`;
                // Ø§ÛŒÙ† ÛŒÚ© Ø®Ø·Ø§ÛŒ Ø±Ø§ÛŒØ¬ Ø§Ø³Øª Ø²Ù…Ø§Ù†ÛŒ Ú©Ù‡ Ù…Ø¯Ù„ URL Ø±Ø§ Ù†Ù…ÛŒ Ø®ÙˆØ§Ù†Ø¯
                if (message.includes("400") && message.includes("URI is not valid")) {
                    message = "Ø®Ø·Ø§: Gemini Ù†ØªÙˆØ§Ù†Ø³Øª ÛŒÚ©ÛŒ Ø§Ø² URL Ù‡Ø§ Ø±Ø§ Ø¨Ø®ÙˆØ§Ù†Ø¯. (Ú©Ø¯ 400). Ù„Ø·ÙØ§Ù‹ URL Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¢Ù† Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯.";
                }
                throw new Error(message);
            }

            const result = await response.json();

            if (result.candidates && result.candidates.length > 0) {
                const finishReason = result.candidates[0].finishReason;
                // MAX_TOKENS ÛŒÚ© Ø¯Ù„ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ø¨Ø±Ø§ÛŒ ØªÙˆÙ‚Ù Ø§Ø³Øª
                if (finishReason !== "STOP" && finishReason !== "MAX_TOKENS") {
                     throw new Error(`Ù¾Ø§Ø³Ø® ØªÙˆØ³Ø· Gemini Ø¨Ù„Ø§Ú© Ø´Ø¯. Ø¯Ù„ÛŒÙ„: ${finishReason}`);
                }
                if (!result.candidates[0].content.parts || result.candidates[0].content.parts.length === 0) {
                    throw new Error(`Ù¾Ø§Ø³Ø® Ø¨Ù„Ø§Ú© Ø´Ø¯. Ø¯Ù„ÛŒÙ„: ${finishReason}. (Ù…Ø­ØªÙˆØ§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª)`);
                }
                return result.candidates[0].content.parts[0].text;
            } else {
                if (result.promptFeedback && result.promptFeedback.blockReason) {
                    throw new Error(`Ù¾Ø±Ø§Ù…Ù¾Øª Ø¨Ù„Ø§Ú© Ø´Ø¯. Ø¯Ù„ÛŒÙ„: ${result.promptFeedback.blockReason}`);
                }
                throw new Error("Invalid response structure from Gemini API.");
            }
        }
        
        // ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ (Ù…Ø´ØªØ±Ú©)
        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, function(m) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
            });
        }

        // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ù„ÛŒØ¯ (Ù…Ø´ØªØ±Ú©)
        function validateApiKey() {
            if (!apiKey) {
                alert("Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ Ú©Ù„ÛŒØ¯ API Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡ ÙˆØ§Ø±Ø¯ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.");
                return false;
            }
            return true;
        }

        // ØªÙ†Ø¸ÛŒÙ… Ø­Ø§Ù„Øª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ú©Ù…Ù‡ (Ù…Ø´ØªØ±Ú©)
        function setLoading(button, text, disabled = true) {
            button.disabled = disabled;
            button.innerHTML = text;
        }

    </script>
</body>
</html>